# ==============================================================================
# Skills API - Docker Compose
# ==============================================================================
# Quick Start:
#   cd docker
#   cp .env.example .env
#   # Edit .env with your API keys
#   docker compose up -d
#
# Access:
#   - Web UI: http://localhost:62600
#   - API: http://localhost:62610
#   - API Docs: http://localhost:62610/docs
#   - Documentation: http://localhost:62630
#
# With Nginx (production):
#   docker compose --profile nginx up -d
#   - Access: http://localhost (or your domain)
#
# For developers building from source, use docker-compose.dev.yaml instead.
# ==============================================================================

name: skills-api

services:
  # ============================================================================
  # Database Service - PostgreSQL
  # ============================================================================
  db:
    image: postgres:16
    container_name: skills-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER:-skills}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-skills123}
      - POSTGRES_DB=${DB_NAME:-skills_api}
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./db/init-test-db.sql:/docker-entrypoint-initdb.d/init-test-db.sql:ro
    ports:
      - "${DB_PORT:-62620}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-skills} -d ${DB_NAME:-skills_api}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - skills-network

  # ============================================================================
  # API Service - FastAPI Backend
  # ============================================================================
  api:
    image: skillcompose/api:0.0.5
    container_name: skills-api
    restart: unless-stopped
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - RAGFLOW_API_KEY=${RAGFLOW_API_KEY:-}
      - RAGFLOW_BASE_URL=${RAGFLOW_BASE_URL:-}
      # Multi-LLM Provider API Keys
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      - AGENT_MAX_TURNS=${AGENT_MAX_TURNS:-60}
      - DEBUG=${DEBUG:-false}
      - TZ=${TZ:-UTC}
      - DATABASE_URL=postgresql+asyncpg://${DB_USER:-skills}:${DB_PASSWORD:-skills123}@db:5432/${DB_NAME:-skills_api}
      # Internal paths (inside container)
      - SKILLS_DIR=/app/skills
      - DATA_DIR=/app/data
      - LOGS_DIR=/app/logs
      - UPLOADS_DIR=/app/uploads
      - CONFIG_DIR=/app/config
      - BACKUPS_DIR=/app/backups
    volumes:
      - skills:/app/skills
      - logs:/app/logs
      - uploads:/app/uploads
      - config:/app/config
      - backups:/app/backups
      - workspaces:/app/workspaces
      - ./.env:/app/.env.seed:ro
    ports:
      - "${API_PORT:-62610}:62610"
    depends_on:
      db:
        condition: service_healthy
      executor-base:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62610/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - skills-network

  # ============================================================================
  # Web Service - Next.js Frontend
  # ============================================================================
  web:
    image: skillcompose/web:0.0.5
    container_name: skills-web
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=http://api:62610
      - NEXT_PUBLIC_DOCS_URL=http://localhost:${DOCS_PORT:-62630}
      - TZ=${TZ:-UTC}
    ports:
      - "${WEB_PORT:-62600}:62600"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:62600/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - skills-network

  # ============================================================================
  # Docs Service - Docusaurus Documentation
  # ============================================================================
  docs:
    image: skillcompose/docs:0.0.5
    container_name: skills-docs
    restart: unless-stopped
    command: ["serve", "-s", "build", "-l", "62630"]
    environment:
      - TZ=${TZ:-UTC}
    ports:
      - "${DOCS_PORT:-62630}:62630"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62630/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - skills-network

  # ============================================================================
  # Nginx - Reverse Proxy (Optional, use --profile nginx)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: skills-nginx
    restart: unless-stopped
    profiles:
      - nginx
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
      - web
    networks:
      - skills-network

  # ============================================================================
  # Executor Services - Code Execution Containers
  # ============================================================================
  executor-base:
    image: skillcompose/executor-base:0.0.5
    container_name: skills-executor-base
    restart: unless-stopped
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=base
      - EXECUTOR_PORT=62680
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62680/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G

  executor-ml:
    image: skillcompose/executor-ml:0.0.5
    container_name: skills-executor-ml
    restart: unless-stopped
    profiles:
      - ml
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=ml
      - EXECUTOR_PORT=62681
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62681/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 8G

  executor-cuda:
    image: skillcompose/executor-cuda:0.0.5
    container_name: skills-executor-cuda
    restart: unless-stopped
    profiles:
      - gpu
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=cuda
      - EXECUTOR_PORT=62682
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62682/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  executor-chemscout:
    image: skillcompose/executor-chemscout:0.0.5
    container_name: skills-executor-chemscout
    restart: unless-stopped
    profiles:
      - chemscout
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=chemscout
      - EXECUTOR_PORT=62680
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62680/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G

  executor-remotion:
    image: skillcompose/executor-remotion:0.0.5
    container_name: skills-executor-remotion
    restart: unless-stopped
    profiles:
      - remotion
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=remotion
      - EXECUTOR_PORT=62680
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62680/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 8G

  executor-diagram:
    image: skillcompose/executor-diagram:0.0.5
    container_name: skills-executor-diagram
    restart: unless-stopped
    profiles:
      - diagram
    volumes:
      - workspaces:/app/workspaces
      - skills:/app/skills:ro
      - uploads:/app/uploads:ro
    environment:
      - EXECUTOR_NAME=diagram
      - EXECUTOR_PORT=62680
      - SKILLS_DIR=/app/skills
      - UPLOADS_DIR=/app/uploads
      - DATA_DIR=/app/data
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:62680/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G

networks:
  skills-network:
    driver: bridge

volumes:
  db_data:
    driver: local
  workspaces:
    driver: local
  skills:
    driver: local
  config:
    driver: local
  logs:
    driver: local
  uploads:
    driver: local
  backups:
    driver: local
